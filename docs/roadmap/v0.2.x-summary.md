# v0.2.x — Persistence & Database Surface (Complete)

Summary of the v0.2.x series. Six versions introducing PostgreSQL persistence and systematically expanding the attack surface.

---

## Timeline

| Version | Title | Key Deliverable |
|---------|-------|-----------------|
| v0.2.0 | Database Introduction | PostgreSQL 16 via Docker Compose, TypeORM, in-memory → repository migration |
| v0.2.1 | Persisted Authentication | Plaintext credentials in PG, verbose DB error leakage (CWE-209) |
| v0.2.2 | Identifier Trust Failures | JwtAuthGuard on all endpoints, ownerId tracked but never enforced (IDOR) |
| v0.2.3 | Enumeration Surface | Unbounded list endpoints, public Swagger, X-Powered-By, OWASP 2025 migration |
| v0.2.4 | Error & Metadata Leakage | Crash-test endpoint, no ValidationPipe, A10:2025 first use |
| v0.2.5 | Persistence Refactoring | TypeORM migrations replace synchronize:true, description column via migration |

---

## Cumulative Stats

| Metric | Value |
|--------|-------|
| CWE entries | 29 |
| E2e tests | 33 |
| Unit tests | 7 |
| E2e test files | 5 (`app`, `auth`, `idor`, `enumeration`, `leakage`) |
| ADRs introduced | 5 (019–023) |
| Database tables | 4 (`user`, `file_entity`, `sharing_entity`, `admin_item`) |
| Migrations | 2 (`InitialSchema`, `AddFileDescription`) |
| OWASP edition | Top 10:2025 (migrated from 2021 in v0.2.3) |

---

## CWEs Introduced in v0.2.x

| CWE | Description | Version | OWASP |
|-----|-------------|---------|-------|
| CWE-798 | Hardcoded DB credentials | v0.2.0 | A07:2025 |
| CWE-1188 | Insecure default init (synchronize:true → partial fix in v0.2.5) | v0.2.0 | A02:2025 |
| CWE-1393 | Default PG password | v0.2.0 | A07:2025 |
| CWE-532 | SQL logging with plaintext passwords | v0.2.0 | A09:2025 |
| CWE-209 | Verbose DB errors (v0.2.1), expanded to runtime errors (v0.2.4) | v0.2.1 | A02:2025, A10:2025 |
| CWE-639 | IDOR — authorization bypass via user-controlled key | v0.2.2 | A01:2025 |
| CWE-862 | Missing authorization (authentication without authorization) | v0.2.2 | A01:2025 |
| CWE-200 | Exposure of sensitive info (list dumps, Swagger, X-Powered-By) | v0.2.3 | A01:2025, A02:2025 |
| CWE-203 | Observable discrepancy (200/404 existence oracle) | v0.2.3 | A01:2025 |
| CWE-400 | Uncontrolled resource consumption (unbounded queries) | v0.2.3 | A06:2025 |

---

## CWEs Carried Forward from v0.1.x

CWE-256 (plaintext passwords), CWE-330 (sequential IDs), CWE-204 (distinct auth errors), CWE-307 (no rate limiting), CWE-347 (weak JWT), CWE-521 (weak password requirements), CWE-613 (no token expiration, cosmetic logout), CWE-922 (localStorage), CWE-942 (permissive CORS), CWE-319 (cleartext transport), CWE-615 (source comments in CSR bundle).

---

## Architecture Decisions

| ADR | Title | Version |
|-----|-------|---------|
| ADR-019 | TypeORM as ORM | v0.2.0 |
| ADR-020 | Docker for DB only (not app) | v0.2.0 |
| ADR-021 | OWASP Top 10:2025 Migration | v0.2.3 |
| ADR-022 | TypeORM Migrations | v0.2.5 |
| ADR-023 | Error Handling Philosophy | v0.2.4 |

---

## Key Technical Changes

### Data layer
- In-memory arrays → TypeORM `Repository<Entity>` backed by PostgreSQL
- All service methods converted to `async`
- `repository.insert()` used over `repository.save()` for explicit PK violation errors
- `synchronize: true` → explicit migrations with `migrationsRun: true` (v0.2.5)
- `description` column added to `file_entity` via migration (v0.2.5)

### Authentication & access control
- JwtAuthGuard applied to all resource controllers (v0.2.2)
- `ownerId` column on `file_entity` and `sharing_entity` — populated but never checked
- No ownership or role verification on any endpoint

### API surface
- `GET /files` list-all endpoint added (v0.2.3)
- `GET /admin/crash-test` crash endpoint added (v0.2.4)
- All list endpoints return unbounded full-table dumps
- Swagger publicly accessible at `/api/docs` without auth
- `X-Powered-By: Express` header not disabled
- No ValidationPipe — malformed input accepted
- NestJS 404 error shape exposed

### Testing
- E2e tests run against real PostgreSQL with `dataSource.synchronize(true)` for isolation
- `--runInBand` for sequential test suite execution
- 5 e2e spec files covering auth, app, IDOR, enumeration, and leakage

---

## What's Next

**v0.3.x — File Handling Surface**: Real file uploads, local filesystem storage, download by ID, public sharing links, MIME confusion, path traversal, oversized uploads.
