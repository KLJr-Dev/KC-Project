# v0.4.x — Authorization & Administrative Surface Summary

## Scope

The v0.4.x series introduces role-based access control (RBAC) with ternary roles,
authorization guards on admin endpoints, privilege escalation, and audit trail
infrastructure. Authorization gaps intentionally persist to demonstrate attack chains.

## Versions

| Version | Focus | Key Changes |
|---------|-------|-------------|
| v0.4.0 | Binary Roles → Ternary Expand | User/admin → user/moderator/admin, role stored in JWT |
| v0.4.1 | (Planning only, shipped with v0.4.0) | — |
| v0.4.2 | JWT Forgery PoC | RBAC e2e tests demonstrating CWE-639 (client-controlled JWT role) |
| v0.4.3 | File Approval | Moderator approval endpoint, 7 e2e tests, role hierarchy ambiguity (CWE-841) |
| v0.4.4 | Privilege Escalation | Moderator escalation chains, audit logs placeholder, 4 e2e tests (CWE-269, CWE-532) |
| v0.4.5 | Missing Authorization | DELETE endpoint without @HasRole guard, 5 inconsistency tests (CWE-862) |
| v0.4.6 | Documentation | ADR-025 RBAC design, auth-flow expansion, security-baseline inventory, threat model updates |

## CWEs Introduced in v0.4.x

| CWE | Description | OWASP 2025 | Introduced |
|-----|-------------|------------|------------|
| CWE-639 | Unauthorized Direct Object Reference (role trusted from JWT) | A01:2025 | v0.4.2 |
| CWE-841 | Role Hierarchy Ambiguity (ternary roles, undefined moderator permissions) | A07:2025 | v0.4.3 |
| CWE-269 | Privilege Escalation (unbounded moderator promotion chains) | A01:2025 | v0.4.4 |
| CWE-862 | Missing Authorization (DELETE endpoint inconsistent guard placement) | A01:2025 | v0.4.5 |
| CWE-532 | No Audit Trail (role changes logged to stdout only) | A09:2025 | v0.4.4 |

CWE-639 was introduced in v0.2.2 as initial IDOR; v0.4.x expands it to authorization context
(client-controlled role claims in JWT, no server-side re-validation).

## CWEs Carried Forward

All CWEs from v0.1.x–v0.3.x remain: CWE-256, CWE-330, CWE-204, CWE-209, CWE-307,
CWE-347, CWE-521, CWE-613, CWE-798, CWE-942, CWE-1188, CWE-1393, CWE-532, CWE-200,
CWE-203, CWE-400, CWE-22, CWE-285, CWE-639, CWE-862, CWE-434.

## Test Coverage

- 6 e2e test suites, **72 total tests** (50 baseline from v0.1-v0.3, +22 RBAC-specific)
- `rbac.e2e-spec.ts`: 11 tests (JWT forgery, role-based access, guard verification)
- `files-approval.e2e-spec.ts`: 7 tests (moderator approval flows, role confusion, hierarchy)
- `escalation.e2e-spec.ts`: 4 tests (cascading moderator promotions, depth attacks)
- `inconsistency.e2e-spec.ts`: 5 tests (authorization bypass, DELETE endpoint, lateral privilege escalation)
- `admin.e2e-spec.ts`: 5 tests (admin endpoints, role guards, escalation boundaries)
- All baseline suites updated to use ternary roles, role selector in tests

## Frontend Surface (v0.4.x)

- **Role Selector Component** (`frontend/app/components/role-modifier.tsx`): Ternary dropdown for user/moderator/admin assignment
- **Admin User List** (`frontend/app/components/admin-user-list.tsx`): Displays users with role, edit capability
- **Header Role Display** (`frontend/app/components/header.tsx`): Shows current user role (user/moderator/admin) with color coding
- **Auth Context** (`frontend/lib/auth-context.tsx`): Stores and persists role to localStorage (CWE-639: client-side modifiable)
- **Admin Page** (`frontend/app/admin/page.tsx`): Ternary role selector, user list, escalation UI

## Backend Changes (Controller & Service)

### AdminModule Expansion

- **AdminController** new endpoints:
  - PUT `/files/:id/approve` — Moderator file review (v0.4.3)
  - PUT `/admin/users/:id/role/escalate` — Moderator role promotion (v0.4.4)
  - GET `/admin/audit-logs` — Audit trail placeholder (v0.4.4)
  - DELETE `/admin/users/:id` — User deletion **WITHOUT @HasRole guard** (v0.4.5, CWE-862)

- **AdminService** new methods:
  - `approveFile(fileId, status)` — File approval logic
  - `escalateUserRole(userId, targetRole)` — Unbounded escalation
  - `getAuditLogs()` — Returns empty array (placeholder)
  - `deleteUser(userId)` — Hard delete from database + filesystem cleanup

- **HasRoleGuard** (`backend/src/auth/guards/has-role.guard.ts`):
  - Decorator: `@HasRole('admin')`, `@HasRole('moderator')`
  - Validates JWT role claim (NOT re-validated from DB)
  - Returns 403 if role insufficient

### Data Model Changes

- **User Entity**: `role` column changed from binary enum to ternary enum
  - Old: `ENUM('user', 'admin')`
  - New: `ENUM('user', 'moderator', 'admin')`
  - Default: 'user'

- **File Entity**: `approvalStatus` column added
  - Type: `VARCHAR` or `ENUM('pending', 'approved', 'rejected')`
  - Added in migration `AddApprovalStatusToFile`

- **JWT Payload Interface**: `role` now carries ternary value (never re-validated from DB)

## Architecture Changes

- **Module Hierarchy**: AdminModule now imports FilesModule for approval operations
- **Guard Placement**: Inconsistent — some endpoints use `@HasRole()`, others don't (v0.4.5)
- **Authorization Pattern**: Guards check JWT claim; server never re-queries User entity for role
- **Audit Logging**: Placeholder only; no persistent audit_logs table or entries

## ADRs

- **ADR-025**: RBAC Design — Documents three-phase implementation (binary, ternary, escalation/missing-auth)
  with rationale for each CWE, alternatives considered, and consequences.

## Schema Changes (Migrations)

### Migrations

`1771427000001-AddModeratorRole.ts` (v0.4.3)
- Alters User role column: `'user'|'admin'` → `'user'|'moderator'|'admin'`
- No data migration (existing users remain 'user' or 'admin' if admin)

`1771427000002-AddApprovalStatusToFile.ts` (v0.4.3)
- Adds `approvalStatus` column to `file_entity`
- Type: `VARCHAR(20)` or `ENUM('pending', 'approved', 'rejected')`
- Default: `'pending'` or NULL

### user_entity

| Column | Type | Changed In | Notes |
|--------|------|------------|-------|
| role | ENUM('user'\|'moderator'\|'admin') | v0.4.3 | Previously binary |

### file_entity

| Column | Added In | Type | Notes |
|--------|----------|------|-------|
| approvalStatus | v0.4.3 | VARCHAR(20) | Moderator review status |

## Documentation Expansions

- **auth-flow.md**: Expanded with v0.4.x authorization flows, JWT forgery sequence diagrams,
  ternary role explanation, escalation chains, missing authorization gaps
- **security-baseline.md**: Added "Current State (v0.4.x)" table with 7 authorization vulnerabilities,
  expanded Authorization Controls section with server/DB-side RBAC recommendations
- **ARCHITECTURE.md**: Updated version to v0.4.5, documented authorization gaps (inconsistent guards,
  trust model, role hierarchy ambiguity), updated AdminController diagram with all 5 endpoints
- **threat-model.md**: Added CWE-862, CWE-841, CWE-532 to v1.0.0 attack surface diagram and inventory table

## Dependencies Added

None. Existing NestJS guards and decorators suffice.

## Vulnerability Snapshot (v0.4.6 Complete)

**Cumulative across v0.1.x–v0.4.x:**
- **Total CWEs:** ~40 intentional, 1 accidental (sequential IDs pre-date project)
- **Authorization Surface:** 5 CWEs (CWE-639, CWE-841, CWE-269, CWE-862, CWE-532)
- **File Handling Surface:** 6 CWEs (CWE-22, CWE-200, CWE-400, CWE-434, CWE-285, CWE-330, CWE-613)
- **Identity Surface:** 8 CWEs (CWE-256, CWE-347, CWE-613, CWE-204, CWE-307, CWE-521, CWE-922, CWE-1188)
- **Data Surface:** 4 CWEs (CWE-330, CWE-639 IDOR, CWE-203, CWE-200)
- **Infrastructure:** 6+ CWEs (CWE-798, CWE-250, CWE-668, CWE-319, CWE-532, CWE-1393)

**Surface Status:**
- ✓ v0.1.x Identity Surface: Complete
- ✓ v0.2.x Persistence Surface: Complete
- ✓ v0.3.x File Handling Surface: Complete
- ✓ v0.4.x Authorization Surface: Complete
- → v0.5.x Deployment & Containerisation Surface: Planned
