# v0.3.x -- File Handling Surface Summary

## Scope

The v0.3.x series introduces real file I/O to the application: multipart
uploads via Multer, local filesystem storage, streaming downloads, filesystem
deletion, and public sharing via predictable tokens.

## Versions

| Version | Focus | Key Changes |
|---------|-------|-------------|
| v0.3.0 | File Upload | Multer diskStorage, multipart POST /files, mimetype/storagePath columns |
| v0.3.1 | File Metadata | storagePath exposed in API responses (CWE-200) |
| v0.3.2 | File Download | GET /files/:id/download, no ownership check |
| v0.3.3 | File Deletion | DELETE /files/:id removes from disk, no path validation |
| v0.3.4 | Public Sharing | publicToken on sharing_entity, unauthenticated GET /sharing/public/:token |
| v0.3.5 | Edge Cases | 12 e2e tests, Swagger 0.3.5, surface closed |

## CWEs Introduced in v0.3.x

| CWE | Description | OWASP 2025 | Introduced |
|-----|-------------|------------|------------|
| CWE-22 | Path Traversal (filename injection, unvalidated storagePath) | A01:2025 | v0.3.0 |
| CWE-200 | Exposure of Sensitive Information (storagePath in API) | A01:2025 | v0.3.0 |
| CWE-285 | Improper Authorization (unauthenticated public endpoint) | A01:2025 | v0.3.4 |
| CWE-330 | Predictable Share Tokens (sequential "share-N") | A01:2025 | v0.3.4 |
| CWE-400 | No Upload Size Limit (Multer limits not configured) | A06:2025 | v0.3.0 |
| CWE-434 | Unrestricted Upload (MIME from client, no magic bytes) | A06:2025 | v0.3.0 |
| CWE-613 | No Expiry Enforcement (expiresAt stored but not checked) | A07:2025 | v0.3.4 |

CWE-200 was already tracked from v0.2.3 (Swagger/X-Powered-By exposure);
v0.3.x expands it to include filesystem path disclosure.

CWE-613 was already tracked from v0.1.4 (JWT replay after logout);
v0.3.x expands it to include sharing expiry bypass.

## CWEs Carried Forward

All CWEs from v0.2.x remain: CWE-256, CWE-330, CWE-204, CWE-209, CWE-307,
CWE-347, CWE-521, CWE-613, CWE-639, CWE-798, CWE-862, CWE-942, CWE-1188,
CWE-1393, CWE-532, CWE-200, CWE-203, CWE-400.

## Test Coverage

- 6 e2e test suites, 44 tests total
- `files.e2e-spec.ts`: 12 tests (upload, download, IDOR, MIME, path traversal, public sharing)
- Updated `idor.e2e-spec.ts`: multipart uploads replace JSON body
- Updated `enumeration.e2e-spec.ts`: multipart uploads replace JSON body
- Updated `leakage.e2e-spec.ts`: documents behaviour with JSON body on multipart endpoint

## Architecture Changes

- `FilesModule` exports `FilesService` (consumed by SharingModule)
- `SharingModule` imports `FilesModule` for public file streaming
- `SharingController` uses per-method `@UseGuards(JwtAuthGuard)` instead of class-level (public endpoint is unauthenticated)
- 2 new TypeORM migrations: `AddFileUploadColumns`, `AddPublicTokenColumn`
- `backend/uploads/` directory with `.gitkeep` (git-ignored contents)

## ADRs

- ADR-024: File Storage Strategy (local filesystem, insecure by design)

## Schema Changes

### file_entity

| Column | Type | Added In |
|--------|------|----------|
| mimetype | character varying (nullable) | v0.3.0 |
| storagePath | character varying (nullable) | v0.3.0 |

### sharing_entity

| Column | Type | Added In |
|--------|------|----------|
| publicToken | character varying (nullable) | v0.3.4 |

## Dependencies Added

- `@types/multer` (devDependency) -- Multer is already bundled with `@nestjs/platform-express`
